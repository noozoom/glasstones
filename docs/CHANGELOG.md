# GlassTones - 変更履歴

## v2025.06.20.1 - スマホ軽量化とエフェクトBUS最適化

### 🚀 重要な軽量化対応（プチプチ音解決）
- **エフェクトBUSシステム導入**: 音ごとにエフェクト作成→全音共有エフェクト
  - **音1つあたりのAudioNode**: 8-10個→3個（66%削減）
  - **16ボイス時のエフェクト**: 16セット→1セット（94%削減）
  - **ルーティング**: `osc → gain → panner → effectBus（共有）`
  - **音量バランス**: 完全維持（同じ最終音量）

### 📱 モバイル視覚軽量化
- **FPS削減**: 30fps→24fps（20%軽量化）
- **フォグ処理軽量化**:
  - 初期透明度: 91%→78%（軽量化）
  - 回復速度: 半減（処理負荷軽減）
  - 回復間隔: 2→4フレーム（50%軽量化）
- **グロー効果**: モバイルで完全無効化
- **プレビュー線**: モバイルで簡易版のみ
- **線の太さ**: 23px→20px（軽量化）

### 🎵 エフェクトBUS詳細仕様
- **共有ディレイ**: 
  - モバイル: 8ms-250ms（軽量化）
  - デスクトップ: 10ms-400ms
- **共有コーラス**: 
  - 3.5ms基本ディレイ
  - 上下位置で1Hz-0.2Hz周期変化
- **共有リバーブ**: 
  - モバイル: 8秒
  - デスクトップ: 15秒
- **垂直位置制御**: エフェクトバス全体をリアルタイム制御

### 🔧 技術的改善
- **ポリフォニック管理**: 変更なし（16/32ボイス）
- **12秒エンベロープ**: 維持（重要な機能）
- **音階システム**: 変更なし（D2-D6）
- **ドローンシステム**: エフェクトバス未使用（直接マスターへ）

## v2025.06.20 - 3次元音響空間とモバイル最適化完成版

### 🎵 3次元音響空間システム実装
- **垂直位置ディレイエフェクト**:
  - **上部**: 短いディレイ（8ms-10ms）で空間的広がり
  - **下部**: 深いディレイ（250ms-400ms）で洞窟のような反響
  - **可変フィードバック**: 10%-50%（位置により変化）
  - **可変ミックス量**: 6%-40%（位置により変化）

- **コーラス周期変化**:
  - **上部**: 1秒周期（1Hz）で速いシマー効果
  - **下部**: 5秒周期（0.2Hz）でゆっくりとした深いうねり
  - **3.5ms基本ディレイ**: 自然なコーラス効果

- **立体音響ルーティング**: 
  ```
  osc → gain → panner → effectBus → [dry + delay + chorus] → reverb → master
  ```

### 📱 モバイル最適化システム
- **デバイス別自動設定**: User-Agent判別で自動切り替え
- **ポリフォニック制限**: 
  - モバイル: 16ボイス
  - デスクトップ: 32ボイス
- **軽量化設定**:
  - ディレイ時間: モバイル8ms-250ms / デスクトップ10ms-400ms
  - リバーブ長: モバイル8秒 / デスクトップ15秒
  - ミックス量: モバイル6%-30% / デスクトップ8%-40%

### 🎨 背景フェードイン完全実装
- **p5.js完全制御**: HTMLとの競合を回避
- **タイミング調整**: ロード後1秒で2秒かけてスムーズフェードイン
- **アルファ値制御**: `backgroundAlpha`変数で`tint(255, alpha)`制御
- **ちらつき防止**: 暗い背景（#1a1a1a）から美しい遷移

### 🎮 ゲーム体験向上
- **即座音響立ち上げ**: STARTボタン押下20ms後にスタート音、20ms→70msで通常音量
- **ドローン最適化**: 100ms後に開始（1秒待機を短縮）
- **UI改善**: ファミコン風STARTボタンと「DRAW YOUR LINE」メッセージ

### 🔧 技術仕様詳細
```javascript
// 垂直位置エフェクト実装
const verticalRatio = ballY / window.innerHeight; // 0 (top) to 1 (bottom)

// モバイル軽量設定
if (IS_MOBILE_AUDIO) {
    const minDelay = 0.008;  // 8ms
    const maxDelay = 0.25;   // 250ms
    const delayMix = 0.06 + (verticalRatio * 0.24); // 6% to 30%
    const feedbackAmount = 0.1 + (verticalRatio * 0.3); // 10% to 40%
}

// コーラス周期変化
const minFreq = 1.0;   // 1 Hz (1秒周期) - 上部
const maxFreq = 0.2;   // 0.2 Hz (5秒周期) - 下部
const chorusFrequency = minFreq + (verticalRatio * (maxFreq - minFreq));
```

### 📊 音響システム仕様
- **12音階**: D2〜D6（線の長さに応じた音階）
- **ドローンシステム**: 
  - D3メインドローン（146.83Hz）: 中央固定
  - A3サブドローン（220Hz）: ボール位置パンニング
- **エフェクトチェーン**: 15秒リバーブ + 可変コーラス + 垂直位置ディレイ
- **音量制御**: 連打減衰、高音減衰、線の古さ減衰、3セントランダマイズ

### 🌐 デプロイ対応
- **静的サイト構成**: Vercel対応完了
- **ファビコン**: カスタムアイコン（背景画像から生成）
- **モバイル対応**: iPhone/Android完全対応

---

## v2025.06.19.2 - 音響システム最終調整版

### 🎵 音響システム完全版実装
- **12音階システム**: D6(1174.66Hz)〜D2(73.42Hz)の完全な12音階実装
- **ドローンシステム最適化**: 
  - D3ドローン(146.83Hz): メインドローン・ルート音、30秒スローアタック、中央固定
  - A3ドローン(220Hz): サブドローン・5度上、35秒スローアタック、ボール位置パンニング
- **音量制御システム**: 
  - 連打減衰: 1回目100%→2回目50%→3回目25%→4回目12.5%
  - 高音減衰: 最低音D2(100%)→最高音D6(45%)の線形減衰
  - 線の古さ減衰: 新しい線100%→10秒経過50%
- **ポリフォニック管理**: 32ボイス制限、最古音の自動停止
- **連打判定**: 50ms以内の同一周波数再生をブロック
- **3セントランダマイズ**: 1秒以内の同音再生時に±3セントの微細チューニング

### 🎮 演奏性改善
- **線の長さ判定調整**: PC版1.34倍、モバイル版0.8倍で長い線ほど低音を強化
- **壁衝突音**: 画面対角線10-30%のランダム音、60%音量
- **音量バランス最適化**: プレイアブル音30%アップ、ドローン音30%ダウン

### 🛠️ 技術的安定性
- **Web Audio API実装**: `sound_simple.js`によるフォールバックシステム
- **エラーハンドリング**: Tone.js問題時の自動切り替え
- **初期化最適化**: 100ms遅延によるプツ音防止
- **デバッグ機能**: コンソールログによる詳細な動作追跡

### 📊 音階マッピング詳細
```
線の長さ → 音階 → 周波数
最短    → D6  → 1174.66Hz (最高音)
↓       → C6  → 1046.50Hz
↓       → A5  → 880.00Hz
↓       → G4  → 392.00Hz
↓       → E4  → 329.63Hz
↓       → D4  → 293.66Hz
↓       → B3  → 246.94Hz
↓       → G3  → 196.00Hz (新規追加)
↓       → E3  → 164.81Hz
↓       → C3  → 130.81Hz
↓       → A2  → 110.00Hz
最長    → D2  → 73.42Hz  (最低音)
```

### 📦 バックアップ情報
- **バックアップファイル**: `GlassTones_v2025.06.19.2_20250619_204820.tar.gz`
- **ファイルサイズ**: 224MB
- **作成日時**: 2025年6月19日 20:48:20
- **含まれる内容**: 完全なプロジェクトファイル、音響システム、ドキュメント

---

## v2025.06.19.3 - プロフェッショナル音響処理版

### 🎛️ ダイナミクス処理システム実装
- **リミッター機能**: DynamicsCompressorNodeによる-6dB制限（20:1レシオ、1ms/10msアタック/リリース）
- **コンプレッサー**: -18dBスレッショルド、4:1レシオ、6dBニー、10ms/100msアタック/リリース
- **LUFS測定**: ITU-R BS.1770-2準拠の簡易実装、リアルタイム50ms更新
- **自動ゲイン調整**: -14LUFS目標値への自動音量調整（±1LUFS精度）

### 📊 音響監視システム
- **リアルタイム表示**: LUFS値、コンプレッサー/リミッター減衰量、自動ゲイン倍率
- **処理チェーン**: masterGain → compressor → limiter → analyser → destination
- **ヘッドルーム確保**: ベースレベル50%に設定してクリッピング防止

### 🎚️ 音響品質向上
- **-14LUFS標準**: ストリーミング配信標準ラウドネスに準拠
- **クリッピング防止**: ハードリミッターによる音響歪み除去
- **ダイナミックレンジ最適化**: 音量の自動バランス調整

### 🔧 技術仕様詳細
```
音響処理チェーン:
シンセ音源 → マスターゲイン(0.5) → コンプレッサー(-18dB/4:1) → 
リミッター(-6dB/20:1) → アナライザー(LUFS測定) → 出力

LUFS計算: -0.691 + 10 * log10(meanSquare)
自動調整: pow(10, lufsError / 20) * 0.01 + current * 0.99
更新間隔: 50ms (20Hz)
```

---

## v2025.06.19.4 - モバイル線長調整版

### 📱 モバイル演奏性大幅改善
- **線の長さ判定修正**: モバイル版で2.5倍長い線が必要に調整
  - **sound_simple.js**: `effectiveMax = maxLength * 0.8 → 2.0`（2.5倍）
  - **sound.js**: `effectiveMax = maxLength * 0.4 → 1.0`（2.5倍）
- **低音取得の適正化**: 短い線での低音発生を防止、より長い線描画が必要
- **PC版は据え置き**: デスクトップ版の線長判定は変更なし

### 🎯 調整理由
- ユーザーフィードバック: 「かなり短い線でも低音になってしまう」
- モバイル画面サイズに対する線長スケールの最適化
- より意図的な演奏操作を促進

---

## v2025.06.19.5 - 軽量化+10dB音量アップ版

### 🔧 パフォーマンス最適化
- **コンプレッサー削除**: 重いコンプレッサーを削除、リミッターのみに簡素化
- **処理チェーン軽量化**: masterGain → limiter → analyser → destination
- **FFTサイズ削減**: 2048 → 1024で処理負荷軽減
- **LUFS更新頻度削減**: 50ms → 200ms間隔で軽量化
- **表示更新最適化**: メーター表示を20%の確率で更新

### 🔊 音量大幅アップ（+10dB）
- **マスターゲイン**: 0.5 → 1.58（+10dB）
- **プレイアブル音**: 0.156 → 0.493（+10dB）
- **D3ドローン**: 0.00315 → 0.01（+10dB）
- **A3ドローン**: 0.002333 → 0.0074（+10dB）

### 🎛️ リミッター最適化
- **スレッショルド**: -6dB → -3dB（高音量対応）
- **レシオ**: 20:1 → 12:1（自然な制限）
- **アタック/リリース**: 1ms/10ms → 2ms/20ms（スムーズな動作）

### 📊 LUFS調整最適化
- **調整閾値**: 1LUFS → 2LUFS（頻度削減）
- **調整速度**: より緩やか（0.01→0.02, 0.99→0.98）
- **ゲイン範囲**: 0.1-2.0 → 0.2-4.0（+10dB対応）
- **ログ頻度**: 2秒 → 4秒間隔

### 🔧 プツ音完全除去
- **マスターフェードイン**: 即座に1.58設定 → 2秒間のlinearRamp
- **ドローン開始遅延**: 100ms → 2.5秒（マスターフェードイン完了後）
- **スムーズ起動**: 急激な音量変化を完全に排除

---

## v2025.06.19 - Vercelデプロイ準備版

### 🎨 UI/UX改善
- **背景画像変更**: 錆びた金属テクスチャ（RUST）に変更
- **ファミコン風UI**: STARTボタンと統一されたスタイルの「DRAW YOUR LINE」メッセージ
- **アニメーション改善**: STARTボタン押下後、即座にボックスが横に伸びる演出を追加
- **レスポンシブ対応**: スマートフォン・PC両対応の縦横比維持

### 🎵 オーディオ改善
- **リリース時間延長**: シンセのリリースを4秒→7秒に延長（+3秒）
- **リバーブ強化**: リバーブ減衰時間を12秒→15秒に延長（+3秒）
- **ポップ音解消**: ドローン起動時の「プツッ」音を防ぐため、2秒間のスムーズフェードイン実装
- **音響空間向上**: より深みのある残響と減衰効果

### 🛠️ 技術的改善
- **画像パス最適化**: 背景画像のキャッシュバスター対応
- **CSS構造改善**: スタイルの統一とアニメーション最適化
- **Vercelデプロイ対応**: 静的サイト化の準備完了

### 📁 ファイル構成
- 新規追加: `assets/rust_bg.jpg` (錆びた金属背景)
- 更新: `index.html`, `style.css`, `sound.js`, `sketch.js`
- ドキュメント: Vercelデプロイ仕様書作成

---

## 今後の予定
- 3次元音響空間のさらなる拡張
- VR/AR対応の検討
- 音楽理論に基づく自動和音生成機能

---

*最新バックアップ: `glasstones_smooth_background_fadein_20250620_005456.tar.gz`* 